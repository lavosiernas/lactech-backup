<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Gera√ß√£o PIX</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #fee; border: 1px solid #fcc; }
        .success { background: #efe; border: 1px solid #cfc; }
    </style>
</head>
<body>
    <h1>üß™ Teste de Gera√ß√£o PIX</h1>
    
    <button onclick="testPixGeneration()">üîÑ Testar Gera√ß√£o de PIX</button>
    
    <div id="results"></div>

    <script>
        // Simular a classe PixPaymentSystem apenas para teste
        class PixPaymentTestSystem {
            constructor() {
                this.pixKey = 'slavosier298@gmail.com';
                this.pixKeyType = 'email';
            }

            generateTxId() {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 15);
                const uniqueId = Math.random().toString(36).substring(2, 10);
                return `PIX_${uniqueId}_${timestamp}_${random}`;
            }

            generatePixQRCode(payment) {
                // Estrutura do QR Code Pix (formato EMV)
                const pixData = {
                    payloadFormatIndicator: '01',
                    pointOfInitiationMethod: '12',
                    merchantAccountInformation: {
                        gui: 'br.gov.bcb.pix',
                        key: this.pixKey,
                        keyType: this.pixKeyType
                    },
                    merchantCategoryCode: '0000',
                    transactionCurrency: '986',
                    transactionAmount: payment.amount.toFixed(2),
                    countryCode: 'BR',
                    merchantName: 'LacTech Sistema Leiteiro',
                    merchantCity: 'BRASIL',
                    additionalDataFieldTemplate: {
                        referenceLabel: payment.txid
                    }
                };

                // Converter para string EMV
                const emvString = this.convertToEMVString(pixData);
                
                return {
                    qrCode: emvString,
                    txid: payment.txid,
                    amount: payment.amount,
                    pixKey: this.pixKey,
                    expiresAt: payment.expires_at
                };
            }

            convertToEMVString(pixData) {
                let emv = '000201';
                emv += '010212';
                emv += '2666';
                emv += '0014br.gov.bcb.pix';
                emv += '01' + this.pixKey.length.toString().padStart(2, '0') + this.pixKey;
                emv += '52040000';
                emv += '5303986';
                emv += '54' + pixData.transactionAmount.length.toString().padStart(2, '0') + pixData.transactionAmount;
                emv += '5802BR';
                emv += '59' + pixData.merchantName.length.toString().padStart(2, '0') + pixData.merchantName;
                emv += '60' + pixData.merchantCity.length.toString().padStart(2, '0') + pixData.merchantCity;
                emv += '62' + '05' + '02' + '02' + pixData.additionalDataFieldTemplate.referenceLabel.length.toString().padStart(2, '0') + pixData.additionalDataFieldTemplate.referenceLabel;
                emv += '6304';
                
                const crc = this.calculateCRC16(emv);
                emv += crc.toString(16).toUpperCase().padStart(4, '0');
                
                return emv;
            }

            calculateCRC16(str) {
                let crc = 0xFFFF;
                for (let i = 0; i < str.length; i++) {
                    crc ^= str.charCodeAt(i) << 8;
                    for (let j = 0; j < 8; j++) {
                        if (crc & 0x8000) {
                            crc = (crc << 1) ^ 0x1021;
                        } else {
                            crc <<= 1;
                        }
                        crc &= 0xFFFF;
                    }
                }
                return crc;
            }
        }

        function testPixGeneration() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">üîÑ Executando teste...</div>';

            try {
                // Criar inst√¢ncia de teste
                const pixSystem = new PixPaymentTestSystem();
                
                // Dados de teste
                const paymentData = {
                    txid: pixSystem.generateTxId(),
                    amount: 1.00,
                    status: 'pending',
                    expires_at: new Date(Date.now() + 30 * 60 * 1000).toISOString(),
                    pix_key: pixSystem.pixKey,
                    pix_key_type: pixSystem.pixKeyType
                };

                console.log('üìã Dados do pagamento:', paymentData);

                // Gerar QR Code
                const qrCodeData = pixSystem.generatePixQRCode(paymentData);

                console.log('‚úÖ QR Code gerado:', qrCodeData);

                // Mostrar resultados
                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Teste Bem-sucedido!</h3>
                        <p><strong>TxID:</strong> ${qrCodeData.txid}</p>
                        <p><strong>Valor:</strong> R$ ${qrCodeData.amount.toFixed(2)}</p>
                        <p><strong>Chave PIX:</strong> ${qrCodeData.pixKey}</p>
                        <p><strong>QR Code EMV:</strong> <code style="word-break: break-all;">${qrCodeData.qrCode}</code></p>
                        <p><strong>Tamanho:</strong> ${qrCodeData.qrCode.length} caracteres</p>
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Erro no Teste</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p><strong>Stack:</strong> <pre>${error.stack}</pre></p>
                    </div>
                `;
            }
        }

        // Executar teste automaticamente ao carregar
        window.addEventListener('load', () => {
            setTimeout(testPixGeneration, 500);
        });
    </script>
</body>
</html>