<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Funcionário - LacTech</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase_config_fixed.js"></script>
    <script src="funcionario_functions_fixed.js"></script>
    <script src="auth_fix.js"></script>
</head>
<body>
    <h1>Teste das Funções do Funcionário</h1>
    <div id="test-results"></div>

    <script>
        async function runTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<p>Executando testes...</p>';

            try {
                // Teste 1: Verificar autenticação
                results.innerHTML += '<h3>Teste 1: Verificação de Autenticação</h3>';
                const authResult = await window.authFix.checkAuthenticationFixed();
                results.innerHTML += `<p>Autenticação: ${authResult ? 'OK' : 'FALHOU'}</p>`;

                if (!authResult) {
                    results.innerHTML += '<p>Usuário não autenticado. Testes interrompidos.</p>';
                    return;
                }

                // Teste 2: Verificar se as funções estão disponíveis
                results.innerHTML += '<h3>Teste 2: Disponibilidade das Funções</h3>';
                const functions = [
                    'loadManagerReportSettings',
                    'loadRecentActivity', 
                    'loadProductionChart',
                    'loadDashboardIndicators',
                    'registerMilkProduction',
                    'getMilkProductionHistory',
                    'getTimeAgo'
                ];

                functions.forEach(func => {
                    const available = typeof window.funcionarioAPI[func] === 'function';
                    results.innerHTML += `<p>${func}: ${available ? 'OK' : 'FALHOU'}</p>`;
                });

                // Teste 3: Testar carregamento de dados do dashboard
                results.innerHTML += '<h3>Teste 3: Carregamento de Dados</h3>';
                
                try {
                    await window.funcionarioAPI.loadDashboardIndicators();
                    results.innerHTML += '<p>Dashboard Indicators: OK</p>';
                } catch (error) {
                    results.innerHTML += `<p>Dashboard Indicators: FALHOU - ${error.message}</p>`;
                }

                try {
                    await window.funcionarioAPI.loadRecentActivity();
                    results.innerHTML += '<p>Recent Activity: OK</p>';
                } catch (error) {
                    results.innerHTML += `<p>Recent Activity: FALHOU - ${error.message}</p>`;
                }

                // Teste 4: Verificar dados do usuário
                results.innerHTML += '<h3>Teste 4: Dados do Usuário</h3>';
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    results.innerHTML += `<p>Usuário ID: ${user.id}</p>`;
                    results.innerHTML += `<p>Email: ${user.email}</p>`;
                    
                    // Buscar dados do usuário na tabela users
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('name, farm_id, role')
                        .eq('id', user.id)
                        .single();
                    
                    if (userError) {
                        results.innerHTML += `<p>Erro ao buscar dados do usuário: ${userError.message}</p>`;
                    } else {
                        results.innerHTML += `<p>Nome: ${userData.name}</p>`;
                        results.innerHTML += `<p>Farm ID: ${userData.farm_id}</p>`;
                        results.innerHTML += `<p>Role: ${userData.role}</p>`;
                    }
                } else {
                    results.innerHTML += '<p>Nenhum usuário autenticado</p>';
                }

                // Teste 5: Verificar dados da fazenda
                results.innerHTML += '<h3>Teste 5: Dados da Fazenda</h3>';
                if (userData?.farm_id) {
                    const { data: farmData, error: farmError } = await supabase
                        .from('farms')
                        .select('name, owner_name, city, state')
                        .eq('id', userData.farm_id)
                        .single();
                    
                    if (farmError) {
                        results.innerHTML += `<p>Erro ao buscar dados da fazenda: ${farmError.message}</p>`;
                    } else {
                        results.innerHTML += `<p>Nome da Fazenda: ${farmData.name}</p>`;
                        results.innerHTML += `<p>Proprietário: ${farmData.owner_name}</p>`;
                        results.innerHTML += `<p>Cidade: ${farmData.city}</p>`;
                        results.innerHTML += `<p>Estado: ${farmData.state}</p>`;
                    }
                }

                // Teste 6: Verificar dados de produção
                results.innerHTML += '<h3>Teste 6: Dados de Produção</h3>';
                if (userData?.farm_id) {
                    const { data: productionData, error: productionError } = await supabase
                        .from('milk_production')
                        .select('id, volume_liters, production_date, shift')
                        .eq('farm_id', userData.farm_id)
                        .order('production_date', { ascending: false })
                        .limit(5);
                    
                    if (productionError) {
                        results.innerHTML += `<p>Erro ao buscar dados de produção: ${productionError.message}</p>`;
                    } else {
                        results.innerHTML += `<p>Registros de produção encontrados: ${productionData?.length || 0}</p>`;
                        if (productionData && productionData.length > 0) {
                            results.innerHTML += '<ul>';
                            productionData.forEach(record => {
                                results.innerHTML += `<li>${record.production_date}: ${record.volume_liters}L (${record.shift})</li>`;
                            });
                            results.innerHTML += '</ul>';
                        }
                    }
                }

                results.innerHTML += '<h3>Testes Concluídos!</h3>';

            } catch (error) {
                results.innerHTML += `<p>Erro durante os testes: ${error.message}</p>`;
                console.error('Erro nos testes:', error);
            }
        }

        // Executar testes quando a página carregar
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html> 