<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Funcionário - Sistema Leiteiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase_config_fixed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="assets/js/pdf-generator.js"></script>
    <script src="funcionario_functions_fixed.js"></script>
    <script>
        // Aguardar configuração do Supabase antes de carregar fix_data_sync_complete.js
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const script = document.createElement('script');
                script.src = 'fix_data_sync_complete.js';
                document.head.appendChild(script);
            }, 1000);
        });
    </script>
    <script src="auth_fix.js"></script>
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="gradient-mesh antialiased">

    <!-- Header -->
    <header class="gradient-forest shadow-xl sticky top-0 z-40 border-b border-forest-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-forest-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">PAINEL DO FUNCIONÁRIO</h1>
                        <p class="text-xs text-white" id="farmNameHeader">Carregando...</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-1">
                    <button class="nav-item active relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="dashboard">
                        Dashboard
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="register">
                        Registrar
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="history">
                        Histórico
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="reports">
                        Relatórios
                    </button>
                </nav>

                <div class="flex items-center space-x-4">
                    <button onclick="openProfileModal()" class="flex items-center space-x-3 text-white hover:text-forest-200 p-2 rounded-lg transition-all">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center overflow-hidden">
                            <img id="headerProfilePhoto" src="" alt="Foto de Perfil" class="w-full h-full object-cover rounded-full hidden">
                            <svg id="headerProfileIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="text-left hidden sm:block">
                            <div class="text-sm font-semibold" id="employeeName">Carregando...</div>
                            <div class="text-xs text-forest-200">Funcionário</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-24 md:pb-4">
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- Welcome Section -->
            <div class="gradient-forest rounded-2xl p-6 mb-6 text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Olá, <span id="employeeWelcome">Carregando...</span>!</h2>
                            <p class="text-forest-200 text-base font-medium mb-3">Registre a produção diária de leite</p>
                            <div class="flex items-center space-x-4">
                                <div class="text-xs font-medium">Última atualização: <span id="currentDateTime">Agora</span></div>
                            </div>
                        </div>
                        <div class="hidden sm:block">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="data-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 gradient-forest rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="todayVolume">--L</div>
                    <div class="text-xs text-slate-500 font-medium">Hoje</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Volume registrado</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="weekAverage">--L</div>
                    <div class="text-xs text-slate-500 font-medium">Média Semanal</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Últimos 7 dias</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="todayRecords">--</div>
                    <div class="text-xs text-slate-500 font-medium">Registros</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Hoje</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="bestDay">--L</div>
                    <div class="text-xs text-slate-500 font-medium">Melhor Dia</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Este mês</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Recent Activity -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Atividades Recentes</h3>
                        <button onclick="showTab('history')" class="text-forest-600 hover:text-forest-700 font-semibold text-sm">Ver Tudo</button>
                    </div>
                    <div class="space-y-3" id="activityList">
                        <div class="text-center py-8">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500 text-sm">Nenhuma atividade recente</p>
                            <p class="text-gray-400 text-xs">Registre dados para ver o histórico</p>
                        </div>
                    </div>
                </div>

                <!-- Production Chart -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Produção dos Últimos 7 Dias</h3>
                    <div class="h-32 flex items-end justify-between space-x-2" id="productionChart">
                        <div class="text-center py-8 w-full">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500 text-sm">Carregando gráfico...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Debug logging function
        function debugLog(message) {
            console.log(`[DEBUG] ${message}`);
        }

        // Check authentication with debug
        async function checkAuthentication() {
            debugLog('Iniciando verificação de autenticação...');
            try {
                const result = await window.authFix.checkAuthenticationFixed();
                debugLog(`Resultado da autenticação: ${result}`);
                return result;
            } catch (error) {
                debugLog(`Erro na autenticação: ${error.message}`);
                return false;
            }
        }

        // Initialize page with debug
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('DOM carregado, iniciando inicialização...');
            
            try {
                debugLog('Verificando autenticação...');
                const isAuthenticated = await checkAuthentication();
                
                if (!isAuthenticated) {
                    debugLog('Usuário não autenticado, parando execução');
                    return;
                }
                
                debugLog('Usuário autenticado, inicializando página...');
                await initializePage();
                debugLog('Página inicializada com sucesso');
                
            } catch (error) {
                debugLog(`Erro durante inicialização: ${error.message}`);
                console.error('Error during page initialization:', error);
            }
        });

        async function initializePage() {
            debugLog('Iniciando initializePage()...');
            
            try {
                debugLog('1. Definindo nome da fazenda...');
                await setFarmName();
                
                debugLog('2. Definindo perfil do funcionário...');
                await setEmployeeProfile();
                
                debugLog('3. Carregando dados do dashboard...');
                await loadDashboardData();
                
                debugLog('4. Carregando configurações do gerente...');
                await window.funcionarioAPI.loadManagerReportSettings();
                
                debugLog('5. Definindo data/hora atual...');
                setCurrentDateTime();
                
                debugLog('initializePage() concluído com sucesso');
            } catch (error) {
                debugLog(`Erro em initializePage(): ${error.message}`);
                throw error;
            }
        }

        // Function to get farm name from Supabase
        async function getFarmName() {
            debugLog('getFarmName() iniciado...');
            try {
                // Primeiro tentar localStorage/sessionStorage
                const farmData = JSON.parse(localStorage.getItem('farmData') || sessionStorage.getItem('farmData') || '{}');
                if (farmData.farm_name) {
                    debugLog(`Nome da fazenda encontrado no cache: ${farmData.farm_name}`);
                    return farmData.farm_name;
                }

                debugLog('Buscando nome da fazenda no banco de dados...');
                // Se não encontrar, buscar no banco de dados
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    debugLog('Nenhum usuário autenticado');
                    return 'Minha Fazenda';
                }

                debugLog(`Usuário autenticado: ${user.email}`);

                // Buscar dados do usuário
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (userError) {
                    debugLog(`Erro ao buscar dados do usuário: ${userError.message}`);
                    return 'Minha Fazenda';
                }

                debugLog(`Farm ID encontrado: ${userData.farm_id}`);

                // Buscar na tabela farms
                if (userData.farm_id) {
                    const { data: farmData, error: farmError } = await supabase
                        .from('farms')
                        .select('name')
                        .eq('id', userData.farm_id)
                        .single();

                    if (!farmError && farmData?.name) {
                        debugLog(`Nome da fazenda encontrado: ${farmData.name}`);
                        return farmData.name;
                    } else {
                        debugLog(`Erro ao buscar fazenda: ${farmError?.message || 'Dados não encontrados'}`);
                    }
                }

                debugLog('Retornando nome padrão da fazenda');
                return 'Minha Fazenda';
            } catch (error) {
                debugLog(`Erro em getFarmName(): ${error.message}`);
                return 'Minha Fazenda';
            }
        }

        // Function to get employee name from Supabase
        async function getEmployeeProfile() {
            debugLog('getEmployeeProfile() iniciado...');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    debugLog('Nenhum usuário autenticado em getEmployeeProfile()');
                    return { name: 'Nome do Funcionário', email: '', whatsapp: '', profile_photo_url: null };
                }

                debugLog(`Buscando perfil do usuário: ${user.email}`);

                const { data, error } = await supabase
                    .from('users')
                    .select('name, email, whatsapp, profile_photo_url')
                    .eq('id', user.id)
                    .single();
                
                if (error) {
                    debugLog(`Erro ao buscar perfil: ${error.message}`);
                    throw error;
                }
                
                debugLog(`Perfil encontrado: ${data.name}`);
                return {
                    name: data?.name || 'Nome do Funcionário',
                    email: data?.email || '',
                    whatsapp: data?.whatsapp || '',
                    profile_photo_url: data?.profile_photo_url || null
                };
            } catch (error) {
                debugLog(`Erro em getEmployeeProfile(): ${error.message}`);
                return { name: 'Nome do Funcionário', email: '', whatsapp: '', profile_photo_url: null };
            }
        }

        // Function to set farm name in header
        async function setFarmName() {
            debugLog('setFarmName() iniciado...');
            try {
                const farmName = await getFarmName();
                const element = document.getElementById('farmNameHeader');
                if (element) {
                    element.textContent = farmName;
                    debugLog(`Nome da fazenda definido: ${farmName}`);
                } else {
                    debugLog('Elemento farmNameHeader não encontrado');
                }
            } catch (error) {
                debugLog(`Erro em setFarmName(): ${error.message}`);
            }
        }

        // Function to extract formal name (second name)
        function extractFormalName(fullName) {
            if (!fullName || typeof fullName !== 'string') {
                return 'Funcionário';
            }
            
            // Remove extra spaces and split
            const names = fullName.trim().split(/\s+/);
            
            // If only one name, return it
            if (names.length === 1) {
                return names[0];
            }
            
            // If two names, return the second
            if (names.length === 2) {
                return names[1];
            }
            
            // For 3 or more names, try to find the most formal name
            // Skip common prefixes and find the second meaningful name
            const skipWords = ['da', 'de', 'do', 'das', 'dos', 'di', 'del', 'della', 'delle', 'delli'];
            
            let formalName = '';
            let nameCount = 0;
            
            for (let i = 0; i < names.length; i++) {
                const name = names[i].toLowerCase();
                
                // Skip common prefixes
                if (skipWords.includes(name)) {
                    continue;
                }
                
                // Count meaningful names
                nameCount++;
                
                // Get the second meaningful name
                if (nameCount === 2) {
                    formalName = names[i];
                    break;
                }
            }
            
            // If we didn't find a second meaningful name, use the second name overall
            if (!formalName && names.length >= 2) {
                formalName = names[1];
            }
            
            // If still no formal name, use the first name
            if (!formalName) {
                formalName = names[0];
            }
            
            // Capitalize first letter
            return formalName.charAt(0).toUpperCase() + formalName.slice(1).toLowerCase();
        }

        async function setEmployeeProfile() {
            debugLog('setEmployeeProfile() iniciado...');
            try {
                const profile = await getEmployeeProfile();
                const farmName = await getFarmName();
                
                // Extract formal name for welcome message
                const formalName = extractFormalName(profile.name);
                
                debugLog(`Definindo perfil: ${profile.name} (${formalName})`);
                
                const elements = {
                    'employeeName': formalName,
                    'employeeWelcome': formalName,
                    'profileName': profile.name,
                    'profileFullName': profile.name,
                    'profileFarmName': farmName,
                    'profileEmail2': profile.email || 'Não disponível',
                    'profilePhone': profile.whatsapp || 'Não disponível'
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    } else {
                        debugLog(`Elemento ${id} não encontrado`);
                    }
                });
                
                debugLog('Perfil do funcionário definido com sucesso');
            } catch (error) {
                debugLog(`Erro em setEmployeeProfile(): ${error.message}`);
            }
        }

        // Load dashboard data from Supabase
        async function loadDashboardData() {
            debugLog('loadDashboardData() iniciado...');
            try {
                // Load dashboard indicators
                debugLog('Carregando indicadores do dashboard...');
                await window.funcionarioAPI.loadDashboardIndicators();
                
                // Load recent activity
                debugLog('Carregando atividades recentes...');
                await window.funcionarioAPI.loadRecentActivity();
                
                // Load production chart
                debugLog('Carregando gráfico de produção...');
                await window.funcionarioAPI.loadProductionChart();

                debugLog('loadDashboardData() concluído com sucesso');
            } catch (error) {
                debugLog(`Erro em loadDashboardData(): ${error.message}`);
                console.error('Error loading dashboard data:', error);
            }
        }

        // Set current date and time in form
        function setCurrentDateTime() {
            debugLog('setCurrentDateTime() iniciado...');
            try {
                const now = new Date();
                const dateTimeString = now.toLocaleString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const element = document.getElementById('currentDateTime');
                if (element) {
                    element.textContent = dateTimeString;
                    debugLog(`Data/hora definida: ${dateTimeString}`);
                } else {
                    debugLog('Elemento currentDateTime não encontrado');
                }
            } catch (error) {
                debugLog(`Erro em setCurrentDateTime(): ${error.message}`);
            }
        }

        // Update current date and time
        function updateDateTime() {
            setCurrentDateTime();
        }

        // Show tab function
        function showTab(tabName) {
            debugLog(`showTab() chamado para: ${tabName}`);
            // Implementation would go here
        }

        // Open profile modal function
        function openProfileModal() {
            debugLog('openProfileModal() chamado');
            // Implementation would go here
        }

        debugLog('Script de debug carregado');
    </script>
</body>
</html> 